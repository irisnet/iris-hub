name: Go
on:
  pull_request:
    branches:
      - master
    tags:
      - v.*
  push:
    branches:
      - master
    tags:
      - v.*
jobs:
  build-images:
    name: Build Images
    runs-on: self-hosted
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v1
      - name: Get image tag      
        run: |
          if [[ ${{github.ref}} == "refs/heads/master" ]]; then
            echo 'export TAG="latest"' >> ~/.bashrc;
          else
            echo 'export TAG=${{github.ref}}' >> ~/.bashrc;
            echo 'export TAG=${{github.base_ref}}, $BASH_ENV';
          fi
          source ~/.bashrc
      - name: build irishub mainnet image
        run: source ~/.bashrc; sudo docker build -t irisnet/irishub .
      - name: build irishub testnet image
        run: source ~/.bashrc; sudo docker build -t irisnet/irishub:testnet- --build-arg NetworkType=testnet .

  push-images:
    name: Push Images
    runs-on: self-hosted
    needs: test-images
    steps:
      - name: Login dockerhub
        run: sudo docker login -u ${{secrets.DOCKER_USER}} -p ${{secrets.DOCKER_PASS}}
      - name: push irishub testnet image
        run: sudo docker push irisnet/irishub:testnet-$TAG
      - name: push irishub mainnet image
        run: sudo docker push irisnet/irishub:$TAG

  test-images:
    name: Test Images
    runs-on: self-hosted
    needs: build-images
    steps:
      - name: Run unit tests
        run: sudo docker run -it -v $(pwd):/irishub irisnet/golang sh -c "make test_unit"
